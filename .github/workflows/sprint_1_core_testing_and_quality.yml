# Sprint 1 – Core Testing & Quality workflow
# Establishes testing infrastructure and quality standards for DAiW Music-Brain
name: "Sprint 1 – Core Testing & Quality"

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  # =============================================================================
  # Python Core Tests - Music-Brain Module
  # =============================================================================
  test-python-core:
    name: Python Core Tests (music_brain)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev,audio,all]
      
      - name: Run pytest on music_brain tests
        run: |
          pytest tests_music-brain/ -v --tb=short --cov=music_brain --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: python-music-brain
          name: music-brain-coverage
        continue-on-error: true

  # =============================================================================
  # Python Penta-Core Tests
  # =============================================================================
  test-python-penta:
    name: Python Tests (penta_core)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev,audio,all]
      
      - name: Run pytest on penta-core tests
        run: |
          pytest tests_penta-core/ -v --tb=short || true
        continue-on-error: true

  # =============================================================================
  # Code Quality - Linting & Formatting
  # =============================================================================
  code-quality:
    name: Code Quality (Black, Flake8, MyPy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy
          pip install -e .
      
      - name: Check code formatting with Black
        run: |
          black --check --line-length 100 music_brain/ tests_music-brain/
      
      - name: Lint with Flake8
        run: |
          flake8 music_brain/ tests_music-brain/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true
      
      - name: Type check with MyPy
        run: |
          mypy music_brain/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true

  # =============================================================================
  # Import Validation - Ensure all modules load correctly
  # =============================================================================
  import-validation:
    name: Import Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .[all]
      
      - name: Validate core imports
        run: |
          python -c "import music_brain; print('✓ music_brain imported')"
          python -c "from music_brain import groove; print('✓ groove module imported')"
          python -c "from music_brain import structure; print('✓ structure module imported')"
          python -c "from music_brain import session; print('✓ session module imported')"
          python -c "from music_brain.data import emotional_mapping; print('✓ emotional_mapping imported')"

  # =============================================================================
  # C++ Build and Tests - Penta-Core
  # =============================================================================
  test-cpp-build:
    name: C++ Build & Test (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            g++ \
            ninja-build \
            libasound2-dev \
            libfreetype6-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DPENTA_BUILD_TESTS=ON \
            -DPENTA_BUILD_PYTHON_BINDINGS=OFF \
            -DPENTA_BUILD_JUCE_PLUGIN=OFF
      
      - name: Build penta_core
        run: |
          cd build
          cmake --build . --target penta_core -j$(nproc)
      
      - name: Build tests
        run: |
          cd build
          cmake --build . --target penta_tests -j$(nproc) || true
        continue-on-error: true
      
      - name: Run C++ tests
        run: |
          cd build
          ctest --output-on-failure --verbose || true
        continue-on-error: true

  # =============================================================================
  # Data Files Validation
  # =============================================================================
  data-validation:
    name: Data Files Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[all]
          pip install pyyaml
      
      - name: Validate JSON data files
        run: |
          python -c "import json; json.load(open('music_brain/data/chord_progressions.json')); print('✓ chord_progressions.json valid')"
          python -c "import json; json.load(open('music_brain/data/genre_pocket_maps.json')); print('✓ genre_pocket_maps.json valid')"
          python -c "import json; json.load(open('music_brain/data/chord_progression_families.json')); print('✓ chord_progression_families.json valid')"
      
      - name: Validate YAML schema files
        run: |
          python -c "import yaml; yaml.safe_load(open('music_brain/data/song_intent_schema.yaml')); print('✓ song_intent_schema.yaml valid')"

  # =============================================================================
  # CLI Command Tests
  # =============================================================================
  cli-tests:
    name: CLI Command Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .[all]
      
      - name: Test CLI availability
        run: |
          daiw --version
          daiw --help
      
      - name: Test CLI subcommands
        run: |
          daiw intent --help || true
          daiw analyze --help || true
          daiw extract --help || true
        continue-on-error: true

  # =============================================================================
  # Test Summary
  # =============================================================================
  test-summary:
    name: Sprint 1 Test Summary
    runs-on: ubuntu-latest
    needs: [test-python-core, test-python-penta, code-quality, import-validation, test-cpp-build, data-validation, cli-tests]
    if: always()
    
    steps:
      - name: Generate test summary
        run: |
          echo "# Sprint 1 – Core Testing & Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Python Core Tests: ${{ needs.test-python-core.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Penta Tests: ${{ needs.test-python-penta.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Import Validation: ${{ needs.import-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- C++ Build & Test: ${{ needs.test-cpp-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Data Files Validation: ${{ needs.data-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CLI Tests: ${{ needs.cli-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Success Criteria" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ All tests pass without errors" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Test coverage > 80% for core modules" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ No breaking changes to public APIs" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Documentation matches implementation" >> $GITHUB_STEP_SUMMARY